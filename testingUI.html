<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Milk Seller App - Auth Test</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Backup CDN -->
    <script>
      if (typeof firebase === "undefined") {
        document.write(
          '<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"><\/script>'
        );
        document.write(
          '<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"><\/script>'
        );
      }
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 100%;
        max-width: 800px;
        display: flex;
        min-height: 600px;
      }
      .form-section {
        flex: 1;
        padding: 3rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .signup-section {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
      }
      .signin-section {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
      }
      h2 {
        margin-bottom: 2rem;
        font-size: 2rem;
        text-align: center;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }
      input {
        width: 100%;
        padding: 1rem;
        border: 2px solid transparent;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
      }
      input:focus {
        outline: none;
        border-color: #4facfe;
        background: white;
        box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
      }
      button {
        width: 100%;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
      }
      button:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .response {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-family: monospace;
        font-size: 0.9rem;
        max-height: 200px;
        overflow-y: auto;
      }
      .hidden {
        display: none;
      }
      .otp-section {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      #recaptcha-container {
        margin: 1rem 0;
      }
      .config-section {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        width: 300px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .config-section h3 {
        margin-bottom: 1rem;
        color: #333;
      }
      .config-section input {
        background: #f5f5f5;
        color: #333;
        margin-bottom: 0.5rem;
      }
      .config-section button {
        background: #667eea;
        color: white;
        border: none;
      }
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          margin: 1rem;
        }
        .config-section {
          position: static;
          margin-bottom: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Configuration Panel -->
    <div class="config-section">
      <h3>ðŸ”§ Configuration</h3>
      <div class="form-group">
        <label>Backend API URL:</label>
        <input
          type="url"
          id="apiUrl"
          value="http://localhost:8000/api"
          placeholder="http://localhost:8000/api"
        />
      </div>
      <div class="form-group">
        <label>Firebase Config (JSON):</label>
        <textarea
          id="firebaseConfig"
          rows="8"
          style="
            width: 100%;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 0.5rem;
          "
        >
                { "apiKey": "AIzaSyDXpu2QF0oLoX9z_Sm5Ymow8VmoqMqlFqA", "authDomain": "chitledger.firebaseapp.com", "projectId": "chitledger", "storageBucket": "chitledger.firebasestorage.app", "messagingSenderId": "317441032251", "appId": "1:317441032251:web:f76fbd9eea17070da91c1e", "measurementId": "G-BT5VPH3SST" }         </textarea
        >
      </div>
      <button onclick="initializeFirebase()">ðŸš€ Initialize Firebase</button>
      <div
        id="configStatus"
        style="margin-top: 1rem; padding: 0.5rem; border-radius: 5px"
      ></div>
    </div>

    <div class="container">
      <!-- Signup Section -->
      <div class="form-section signup-section">
        <h2>ðŸ“± Sign Up</h2>

        <div class="form-group">
          <label for="signupPhone">Phone Number (with country code):</label>
          <input
            type="tel"
            id="signupPhone"
            placeholder="+919876543210"
            required
          />
        </div>

        <div class="form-group">
          <label for="signupName">Full Name:</label>
          <input type="text" id="signupName" placeholder="John Doe" required />
        </div>

        <button onclick="sendSignupOTP()" id="sendSignupOTPBtn">
          Send OTP
        </button>

        <div id="signupOTPSection" class="otp-section hidden">
          <div class="form-group">
            <label for="signupOTPCode">Enter OTP:</label>
            <input
              type="text"
              id="signupOTPCode"
              placeholder="123456"
              maxlength="6"
            />
          </div>
          <button onclick="verifySignupOTP()" id="verifySignupOTPBtn">
            Verify & Sign Up
          </button>
        </div>

        <div id="recaptcha-container-signup"></div>
        <div id="signupResponse" class="response hidden"></div>
      </div>

      <!-- Signin Section -->
      <div class="form-section signin-section">
        <h2>ðŸ”“ Sign In</h2>

        <div class="form-group">
          <label for="signinPhone">Phone Number (with country code):</label>
          <input
            type="tel"
            id="signinPhone"
            placeholder="+919876543210"
            required
          />
        </div>

        <button onclick="sendSigninOTP()" id="sendSigninOTPBtn">
          Send OTP
        </button>

        <div id="signinOTPSection" class="otp-section hidden">
          <div class="form-group">
            <label for="signinOTPCode">Enter OTP:</label>
            <input
              type="text"
              id="signinOTPCode"
              placeholder="123456"
              maxlength="6"
            />
          </div>
          <button onclick="verifySigninOTP()" id="verifySigninOTPBtn">
            Verify & Sign In
          </button>
        </div>

        <div id="recaptcha-container-signin"></div>
        <div id="signinResponse" class="response hidden"></div>
      </div>
    </div>

    <script>
      let firebaseApp = null;
      let signupConfirmationResult = null;
      let signinConfirmationResult = null;
      let apiBaseUrl = "http://localhost:8000/api";

      // Initialize Firebase with user config
      function initializeFirebase() {
        const configText = document.getElementById("firebaseConfig").value;
        const statusDiv = document.getElementById("configStatus");

        try {
          const firebaseConfig = JSON.parse(configText);

          // Initialize Firebase
          if (firebaseApp) {
            firebaseApp.delete();
          }

          firebaseApp = firebase.initializeApp(firebaseConfig);

          // Initialize reCAPTCHA
          window.recaptchaVerifierSignup = new firebase.auth.RecaptchaVerifier(
            "recaptcha-container-signup",
            {
              size: "normal",
              callback: (response) => {
                console.log("Signup reCAPTCHA solved");
              },
            }
          );

          window.recaptchaVerifierSignin = new firebase.auth.RecaptchaVerifier(
            "recaptcha-container-signin",
            {
              size: "normal",
              callback: (response) => {
                console.log("Signin reCAPTCHA solved");
              },
            }
          );

          // Update API URL
          apiBaseUrl = document.getElementById("apiUrl").value;

          statusDiv.innerHTML = "âœ… Firebase initialized successfully!";
          statusDiv.style.background = "#d4edda";
          statusDiv.style.color = "#155724";
        } catch (error) {
          console.error("Firebase initialization error:", error);
          statusDiv.innerHTML = `âŒ Error: ${error.message}`;
          statusDiv.style.background = "#f8d7da";
          statusDiv.style.color = "#721c24";
        }
      }

      // Signup Flow
      async function sendSignupOTP() {
        const phoneNumber = document.getElementById("signupPhone").value;
        const sendBtn = document.getElementById("sendSignupOTPBtn");
        const responseDiv = document.getElementById("signupResponse");

        if (!firebaseApp) {
          showResponse(
            "signupResponse",
            "Please initialize Firebase first!",
            "error"
          );
          return;
        }

        if (!phoneNumber) {
          showResponse("signupResponse", "Please enter phone number", "error");
          return;
        }

        try {
          sendBtn.disabled = true;
          sendBtn.textContent = "Sending OTP...";

          const auth = firebase.auth();
          signupConfirmationResult = await auth.signInWithPhoneNumber(
            phoneNumber,
            window.recaptchaVerifierSignup
          );

          document
            .getElementById("signupOTPSection")
            .classList.remove("hidden");
          showResponse(
            "signupResponse",
            `âœ… OTP sent to ${phoneNumber}`,
            "success"
          );

          sendBtn.textContent = "OTP Sent!";
        } catch (error) {
          console.error("Error sending OTP:", error);
          showResponse("signupResponse", `âŒ Error: ${error.message}`, "error");
          sendBtn.disabled = false;
          sendBtn.textContent = "Send OTP";
        }
      }

      async function verifySignupOTP() {
        const otpCode = document.getElementById("signupOTPCode").value;
        const fullName = document.getElementById("signupName").value;
        const phoneNumber = document.getElementById("signupPhone").value;
        const verifyBtn = document.getElementById("verifySignupOTPBtn");

        if (!otpCode || !fullName) {
          showResponse("signupResponse", "Please fill all fields", "error");
          return;
        }

        try {
          verifyBtn.disabled = true;
          verifyBtn.textContent = "Verifying...";

          // Verify OTP with Firebase
          const result = await signupConfirmationResult.confirm(otpCode);
          const idToken = await result.user.getIdToken();

          showResponse(
            "signupResponse",
            "ðŸ”„ OTP verified! Creating account...",
            "info"
          );

          // Send to Django backend
          const response = await fetch(`${apiBaseUrl}/auth/signup/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              phone_number: phoneNumber,
              full_name: fullName,
              firebase_id_token: idToken,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showResponse(
              "signupResponse",
              `ðŸŽ‰ Signup successful!\n\nUser Data:\n${JSON.stringify(
                data.user,
                null,
                2
              )}\n\nTokens received:\n- Access Token: ${data.access_token.substring(
                0,
                50
              )}...\n- Refresh Token: ${data.refresh_token.substring(
                0,
                50
              )}...`,
              "success"
            );

            // Store tokens for testing
            localStorage.setItem("access_token", data.access_token);
            localStorage.setItem("refresh_token", data.refresh_token);
          } else {
            showResponse(
              "signupResponse",
              `âŒ Backend Error:\n${JSON.stringify(data, null, 2)}`,
              "error"
            );
          }
        } catch (error) {
          console.error("Verification error:", error);
          showResponse("signupResponse", `âŒ Error: ${error.message}`, "error");
        } finally {
          verifyBtn.disabled = false;
          verifyBtn.textContent = "Verify & Sign Up";
        }
      }

      // Signin Flow
      async function sendSigninOTP() {
        const phoneNumber = document.getElementById("signinPhone").value;
        const sendBtn = document.getElementById("sendSigninOTPBtn");

        if (!firebaseApp) {
          showResponse(
            "signinResponse",
            "Please initialize Firebase first!",
            "error"
          );
          return;
        }

        if (!phoneNumber) {
          showResponse("signinResponse", "Please enter phone number", "error");
          return;
        }

        try {
          sendBtn.disabled = true;
          sendBtn.textContent = "Sending OTP...";

          const auth = firebase.auth();
          signinConfirmationResult = await auth.signInWithPhoneNumber(
            phoneNumber,
            window.recaptchaVerifierSignin
          );

          document
            .getElementById("signinOTPSection")
            .classList.remove("hidden");
          showResponse(
            "signinResponse",
            `âœ… OTP sent to ${phoneNumber}`,
            "success"
          );

          sendBtn.textContent = "OTP Sent!";
        } catch (error) {
          console.error("Error sending OTP:", error);
          showResponse("signinResponse", `âŒ Error: ${error.message}`, "error");
          sendBtn.disabled = false;
          sendBtn.textContent = "Send OTP";
        }
      }

      async function verifySigninOTP() {
        const otpCode = document.getElementById("signinOTPCode").value;
        const phoneNumber = document.getElementById("signinPhone").value;
        const verifyBtn = document.getElementById("verifySigninOTPBtn");

        if (!otpCode) {
          showResponse("signinResponse", "Please enter OTP code", "error");
          return;
        }

        try {
          verifyBtn.disabled = true;
          verifyBtn.textContent = "Verifying...";

          // Verify OTP with Firebase
          const result = await signinConfirmationResult.confirm(otpCode);
          const idToken = await result.user.getIdToken();

          showResponse(
            "signinResponse",
            "ðŸ”„ OTP verified! Signing in...",
            "info"
          );

          // Send to Django backend
          const response = await fetch(`${apiBaseUrl}/auth/login/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              phone_number: phoneNumber,
              firebase_id_token: idToken,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showResponse(
              "signinResponse",
              `ðŸŽ‰ Signin successful!\n\nUser Data:\n${JSON.stringify(
                data.user,
                null,
                2
              )}\n\nTokens received:\n- Access Token: ${data.access_token.substring(
                0,
                50
              )}...\n- Refresh Token: ${data.refresh_token.substring(
                0,
                50
              )}...`,
              "success"
            );

            // Store tokens for testing
            localStorage.setItem("access_token", data.access_token);
            localStorage.setItem("refresh_token", data.refresh_token);
          } else {
            showResponse(
              "signinResponse",
              `âŒ Backend Error:\n${JSON.stringify(data, null, 2)}`,
              "error"
            );
          }
        } catch (error) {
          console.error("Verification error:", error);
          showResponse("signinResponse", `âŒ Error: ${error.message}`, "error");
        } finally {
          verifyBtn.disabled = false;
          verifyBtn.textContent = "Verify & Sign In";
        }
      }

      // Utility function to show responses
      function showResponse(elementId, message, type) {
        const responseDiv = document.getElementById(elementId);
        responseDiv.classList.remove("hidden");
        responseDiv.textContent = message;

        // Style based on type
        responseDiv.style.background =
          type === "error"
            ? "rgba(255,0,0,0.1)"
            : type === "success"
            ? "rgba(0,255,0,0.1)"
            : "rgba(255,255,0,0.1)";
        responseDiv.style.border =
          type === "error"
            ? "1px solid rgba(255,0,0,0.3)"
            : type === "success"
            ? "1px solid rgba(0,255,0,0.3)"
            : "1px solid rgba(255,255,0,0.3)";
      }

      // Test API endpoint function
      async function testAPI() {
        const token = localStorage.getItem("access_token");
        if (!token) {
          alert("Please signup or signin first to get a token");
          return;
        }

        try {
          const response = await fetch(`${apiBaseUrl}/user/me/`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const data = await response.json();
          alert(
            response.ok
              ? `Profile Data:\n${JSON.stringify(data, null, 2)}`
              : `Error:\n${JSON.stringify(data, null, 2)}`
          );
        } catch (error) {
          alert(`Network Error: ${error.message}`);
        }
      }

      // Add test API button
      window.addEventListener("DOMContentLoaded", () => {
        const testButton = document.createElement("button");
        testButton.textContent = "ðŸ§ª Test Profile API";
        testButton.onclick = testAPI;
        testButton.style.position = "fixed";
        testButton.style.bottom = "20px";
        testButton.style.left = "20px";
        testButton.style.padding = "10px 20px";
        testButton.style.background = "#28a745";
        testButton.style.color = "white";
        testButton.style.border = "none";
        testButton.style.borderRadius = "25px";
        testButton.style.cursor = "pointer";
        testButton.style.zIndex = "1000";
        document.body.appendChild(testButton);
      });
    </script>
  </body>
</html>
